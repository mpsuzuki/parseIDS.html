<html>
  <head>
    <title>parseIDS</title>
    <style>
    <!--
    body {
      text-align: center;
    }
    #wrapper {
      text-align: left;
      width: 100%;
      margin: 0;
      auto;
    }
    #maincontainer {
      text-align: left;
      width: 79%;
      margin-left: 1%;
      float: left;
    }
    #sidebar {
      text-align: left;
      width: 20%;
      float: left;
      background-color: AFAFAF;
    }
    #footer {
      clear: both;
      width: 100%;
    }
    -->
    </style>
  </head>
  <body>
    <script type="text/javascript">
    <!--
      var showDebug = false;
      var showOptions = false;
      var pngDir = null;
      var usePng = false;
      var maxPngPerPage = 10;
      var curPngPage = 0;
      var sideBarWidthPercent = 20;
      var sortTotalStroke = false;
      var foundChars = null;

      function deleteAllNodeInElm(elmName) {
        var sidebarObj = document.getElementById(elmName);
        var chNodes = sidebarObj.childNodes;
        var numChNodes = chNodes.length;
        for (var i = numChNodes; i > 0; ) {
          i -= 1;
          sidebarObj.removeChild(chNodes[i]);
        }
      }

      function shrinkSideBar() {
        deleteAllNodeInElm("sidebarTop");
        deleteAllNodeInElm("sidebarBody");
       
        document.getElementById("sidebar").style.width = "0%";
      }

      function expandSideBar() {
        document.getElementById("sidebar").style.width = sideBarWidthPercent.toString(10) + "%";

        var formAtomicIds = document.createElement("FORM");
        var buttonAtomicIds = document.createElement("INPUT");
        buttonAtomicIds.type = "button";
        buttonAtomicIds.id = "switchAtomicIds";
        buttonAtomicIds.value = "show atomic IDS";
        buttonAtomicIds.onclick = function() { showAtomicIds(); };
        formAtomicIds.appendChild(buttonAtomicIds);

        document.getElementById("sidebarTop").appendChild(formAtomicIds);
      }

      function updateSideBar() {
        if (document.getElementById("chkboxForSideBar").checked) {
          expandSideBar();
        } else {
          shrinkSideBar();
        }
      }

      function utf16Str2UcsArr(ustr) {
        var i, c, arr;
        arr = new Array();
        for (i = 0; i < ustr.length; i += 1) {
          c = ustr.charCodeAt(i);
          if (0xD800 <= c && c <= 0xDBFF && (i+1) < ustr.length) {
            c = ustr.charCodeAt(i+1);
            if (0xDC00 <= c && c <= 0xDFFF) {
              arr.push(ustr.substr(i,2));
              i += 1;
              continue;
            }
          }
          arr.push(ustr.substr(i,1));
        }
        return arr;
      }

      function ucsArrToUcs4Codepoint(ustr) {
        if (ustr.length > 1) {
          return ( ((ustr.charCodeAt(0) & 0x03FF) << 10) + (ustr.charCodeAt(1) & 0x03FF) + 0x10000);
        }
        return ustr.charCodeAt(0);
      }

      var IdsItem = function() {
        this.idsArrays = new Array();
        this.cacheN = new Array();
      }
      IdsItem.prototype.setUcs = function(ucs) {
        this.ucs = ucs;
        return this;
      }
      IdsItem.prototype.setIdss = function(idss) {
        this.idss = idss;
        for (i in this.idss) {
          this.idsArrays[i] = utf16Str2UcsArr(this.idss[i]);
        }
        return this;
      }
      IdsItem.prototype.countAComponent = function(c) {
        var i, j, u;
        var idsArr;
        var numFound, maxNumFound;
        if ( this.cacheN[c] != undefined ) {
          return this.cacheN[c];
        } else if ( this.ucs == c ) {
          maxNumFound = 1;
        } else {
          maxNumFound = 0;
          for ( i in this.idss ) {
            numFound = 0;
            idsArr = this.idsArrays[i];
            if (idsArr.length > 1) {
              for ( j in idsArr ) {
                u = idsArr[j];
                if ( idsDB[u] != undefined ) {
                  numFound += idsDB[u].countAComponent(c);
                }
              }
            }
            maxNumFound = Math.max(maxNumFound, numFound);
          }
        }

        this.cacheN[c] = maxNumFound;
        return maxNumFound;
      }



      // -------------------------------------------------------
      var brokenFileApi = false;

      var idsDB = new Array();
      var hasIdsDB = false;
      var idsText = new String();

      var unihanDB = new Array();
      var hasUnihanDB = false;
      var unihanText = new String();

      function setGlobalText(destName, str) {
        switch (destName) {
        case "idsText":
          idsText = str;
          break;
        case "unihanText":
          unihanText = str;
          break;
        default:
          break;
        }
      }

      function getGlobalText(destName) {
        switch (destName) {
        case "idsText":
          return idsText;
        case "unihanText":
          return unihanText;
        default:
          return null;
        }
      }
      // -------------------------------------------------------
      function loadFileByXHR(filePath, destName, msgElm, curBtn, nxtBtn) {
        var err;
        var req;
        curBtn.disabled = true;
        if (window.ActiveXObject) {
          req = new ActiveXObject('Microsoft.XMLHTTP');
        } else {
          req = new XMLHttpRequest();
        }
        req.open('GET', filePath, false);
        try {
          req.send(null);
        }
        catch (err) {
          if (err.code) {
            msgElm.innerHTML = "Error in reading " + filePath + " by " + err.message;
          } else {
            nxtBtn.disabled = false;
            setGlobalText(destName, req.responseText);
            msgElm.innerHTML = destObj.length.toString(10) + " bytes loaded";
          }
        }
        curBtn.disabled = false;
        return err.code;
      }

      function loadFileByFileAPI(filePath, destName, msgElm, curBtn, nxtBtn) {
        var fileReader = new FileReader();
        var fileIsLoaded = false;
        curBtn.disabled = true;
        fileReader.onload = function(event) {
          var loadedText = event.target.result;
          setGlobalText(destName, loadedText);
          msgElm.innerHTML = loadedText.length.toString(10) + " bytes loaded";
          curBtn.disabled = false;
          nxtBtn.disabled = false;
          fileIsLoaded = true;
        }
        fileReader.readAsText(filePath, "utf-8");
        if (fileReader.readyState == 2 && !fileIsLoaded) {
          brokenFileApi = true;
          msgElm.innerHTML = "Error in reading " + filePath + " by File API, retry with XHR";
          loadFileByXHR(filePath, destName, msgElm, curBtn, nxtBtn);
        }
      }

      function loadFile(filePath, destName, msgElm, curBtn, nxtBtn) {
        curBtn.disabled = true;
        if (window.File && window.FileReader && !brokenFileApi) {
          loadFileByFileAPI(filePath, destName, msgElm, curBtn, nxtBtn);
        } else {
          loadFileByXHR(filePath, destName, msgElm, curBtn, nxtBtn);
        }
        if (showDebug) {
          msgElm.innerHTML = "<pre>" + getGlobalText(destName) + "</pre>";
        }
      }

      function loadIdsFile() {
        loadFile(document.IdsFile.pathToIds.files[0], "idsText", document.getElementById("msgStatus"), document.getElementById("buttonToLoadIds"), document.getElementById("buttonToParseIds"));
      }

      function loadUnihanFile() {
        loadFile(document.UnihanFile.pathToUnihan.files[0], "unihanText", document.getElementById("msgStatus"), document.getElementById("buttonToLoadUnihan"), document.getElementById("buttonToParseUnihan"));
      }

      // TODO: array cannot hold more than 0xFFFF members!
      function parseIdsText() {
        document.getElementById("buttonToParseIds").disabled = true;
        var ucsName, ucs, toks, i, j, k;
        var idsItems = idsText.split("\n");
        for ( i in idsItems ) {
          toks = idsItems[i].split("\t");
          ucsName = toks.shift();
          ucs = toks.shift();
          idsDB[ucs] = new IdsItem().setUcs(ucs).setIdss(toks);
        }

        hasIdsDB = true;
        document.getElementById("msgStatus").innerHTML = idsItems.length.toString(10) + " items parsed";
        document.getElementById("buttonToParseIds").disabled = false;
      }

      function hideAtomicIds() {
        document.getElementById("switchAtomicIds").value = "show atomic IDS";
        document.getElementById("switchAtomicIds").onclick = function() { showAtomicIds(); };
        document.getElementById("sidebarBody").innerHTML = "";
      }

      function showAtomicIds() {
        if ( hasIdsDB ) {
          var atomicIds = new Array();
          for ( ucs in idsDB ) {
            if ( 1 == idsDB[ucs].idsArrays.length && ucs == idsDB[ucs].idsArrays[0] ) {
              atomicIds.push(ucs);
            }
          }
        }
        document.getElementById("sidebarBody").innerHTML = atomicIds.join(", ");
        document.getElementById("switchAtomicIds").value = "hide atomic IDS";
        document.getElementById("switchAtomicIds").onclick = function() { hideAtomicIds(); };
      }

      function parseUnihanText() {
        document.getElementById("buttonToParseUnihan").disabled = true;
        var i, j, l, toks, u, ustr, prop, val;
        var unihanItems = unihanText.split("\n");
        j = 0;
        for ( i in unihanItems ) {
          if ( unihanItems[i].slice(0,2) == "U+" ) {
            toks = unihanItems[i].split("\t");
            l = toks[0].length;
            u = parseInt(toks[0].slice(2,l), 16);
            if (u < 0x10000) {
              ustr = String.fromCharCode(u);
            } else if (u < 0xEFFFF) {
              ustr = String.fromCharCode( ( ( u - 0x10000 ) >> 10 ) | 0xD800, ( ( u - 0x10000 ) & 0x3FF) | 0xDC00 );
            } else {
              continue;
            }
            prop  = toks[1];
            val   = toks[2];
            if ( prop != "kTotalStrokes" ) {
              continue;
            }
            if ( unihanDB[prop] == undefined ) {
              unihanDB[prop] = new Array();
            }
            unihanDB[prop][ustr] = parseInt(val, 10);
            j += 1;
          }
        }
        hasUnihanDB = true;
        unihanText = "";
        document.getElementById("msgStatus").innerHTML = j + " items parsed";
        document.getElementById("buttonToParseUnihan").disabled = false;
        document.getElementById("chkboxForTotalStrokeSort").disabled = false;
      }

      function addHexCodePointToUcsArray(inArr) {
        outArr = new Array();
        for ( var i in inArr ) {
          if ( !hasUnihanDB ) {
            outArr.push( inArr[i] + "(U+" + ucsArrToUcs4Codepoint(inArr[i]).toString(16).toUpperCase() + ")" );
          } else if ( unihanDB["kTotalStrokes"] == undefined || inArr[i] == undefined || unihanDB["kTotalStrokes"][inArr[i]] == undefined ) {
            outArr.push( inArr[i] + "(U+" + ucsArrToUcs4Codepoint(inArr[i]).toString(16).toUpperCase() + ":XXX)" );
          } else {
            outArr.push( inArr[i] + "(U+" + ucsArrToUcs4Codepoint(inArr[i]).toString(16).toUpperCase() + ":" + unihanDB["kTotalStrokes"][inArr[i]].toString(10) + ")" );
          }
        }
        return outArr;
      }

      function addPngTagToUcsArray(inArr) {
        var outArr = new Array();
        for ( var i in inArr ) {
          var ustr = inArr[i].split("(");
          var uhex = ucsArrToUcs4Codepoint(ustr[0]).toString(16).toUpperCase();
          var subDir = uhex.slice(0,-2);
          outArr.push( "<tr><td>" + inArr[i] + "</td><td><img height=50 align=\"middle\" src=\"" + pngDir + "/" + subDir + "/U+" + uhex + ".png\"></td></tr>" );
        }
        return outArr;
      }

      function showFoundResult(arr) {
        if (document.getElementById("chkboxForHexUcs").checked) {
          arr = addHexCodePointToUcsArray(arr);
        }

        if (usePng) {
          arr = addPngTagToUcsArray(arr);
          document.getElementById("foundIdsBody").innerHTML = "<table>" + arr.join("") + "</table>";
        } else {
          document.getElementById("foundIdsBody").innerHTML = arr.join(", ");
        }
      }

      function sortFoundCharsByTotalStrokes() {
        if (!hasUnihanDB) {
          return;
        }
        if (foundChars == null) {
          return;
        }
        foundChars = foundChars.sort(function(a, b) {
          var tsa = unihanDB["kTotalStrokes"][a];
          var tsb = unihanDB["kTotalStrokes"][b];
          if (tsa != undefined && tsb != undefined) {
            return (tsa - tsb);
          } else if (tsa == undefined && tsb == undefined) {
            return (a - b);
          } else if (tsa != undefined) {
            return -1;
          } else {
            return 1;
          }
        });
      }

      function sortFoundCharsByUCS() {
        if (foundChars == null) {
          return;
        }
        var foundCharsUCS = new Array();
        for ( var i = foundChars.length; i > 0; ) {
          i -= 1;
          foundCharsUCS[foundChars[i]] = ucsArrToUcs4Codepoint(foundChars[i]);
        }
        foundChars = foundChars.sort(function(a, b) {
          return (foundCharsUCS[a] - foundCharsUCS[b]);
        });
      }

      function showFoundCharsPartial() {
        curPngPage = parseInt(document.getElementById("pngPageSelector").value, 10);
        var arrToShow = foundChars.slice(maxPngPerPage * curPngPage, maxPngPerPage * (curPngPage + 1));
        showFoundResult(arrToShow);
      }

      function showFoundChars() {
        if (foundChars == null) {
          return;
        }
        var arrToShow;
        if (usePng && foundChars != null && foundChars.length > maxPngPerPage) {
          var foundIdsHeader = document.getElementById("foundIdsHeader");
          var pageSelector = document.getElementById("pngPageSelector");
          if (pageSelector != undefined) {
            foundIdsHeader.removeChild(pageSelector);
          }
          pageSelector = document.createElement("SELECT");
          pageSelector.id = "pngPageSelector";
          pageSelector.size = 1;
          for ( var pageNum = 0; pageNum < (foundChars.length / maxPngPerPage); pageNum += 1 ) {
            var pageSelectorItem = document.createElement("OPTION");
            var pageSelectorItemNote = document.createTextNode(pageNum.toString(10));
            pageSelectorItem.value = pageNum;
            if (pageNum == curPngPage) {
              pageSelectorItem.selected = true;
            }
            pageSelectorItem.appendChild(pageSelectorItemNote);
            pageSelector.appendChild(pageSelectorItem);
          }
          pageSelector.addEventListener("change", function() {
            showFoundCharsPartial();
          });
          document.getElementById("foundIdsHeader").appendChild(pageSelector);

          showFoundCharsPartial();
        } else {
          arrToShow = foundChars.slice(0);
          showFoundResult(arrToShow);
        }
      }

      function lookupComponents() {
        var components = utf16Str2UcsArr(document.checkComponent.components.value);
        var lookupDB = new Array();
        var candidates = new Array();
        var results = new Array();
        var i, c, u;

        for ( i in components ) {
          c = components[i];
          if ( lookupDB[c] == undefined ) {
            lookupDB[c] = 1;
          } else {
            lookupDB[c] += 1;
          }
        }

        for ( u in idsDB ) {
          candidates.push(u);
        }

        for ( c in lookupDB ) {
          for ( i in candidates ) {
            u = candidates[i];
            if ( idsDB[u].countAComponent(c) >= lookupDB[c] ) {
              results.push(u);
            }
          }
          candidates = results;
          results = new Array();
        }

        foundChars = candidates.slice(0);
        curPngPage = 0;

        if (sortTotalStroke) {
          sortFoundCharsByTotalStrokes();
        }

        showFoundChars();
      }

      function decomposeSelectedComponents(wholeString, selectionStart, selectionEnd) {
        var c, d, u, i, j, k, l;
        for ( j = selectionEnd - 1; selectionStart <= j ; j -= 1 ) {
          l = wholeString.length;
          k = j + 1;
          c = wholeString.charCodeAt(j);
          if (0xD800 <= c && c <= 0xDBFF && (j+1) < l) {
            d = wholeString.charCodeAt(j+1);
            if (0xDC00 <= d && d <= 0xDFFF) {
              k = j + 2;
            }
          }
          u = wholeString.substring(j,k);
          var curHead = wholeString.substring(0,j);
          var curTail = wholeString.substring(k,l);
          if (idsDB[u] != undefined && idsDB[u].idss.length > 0) {
            wholeString = curHead + "(" + idsDB[u].idss.join("|") + ")" + curTail;
          }
        }
        return wholeString;
      }

      function wrapDecomposeSelectedComponents(formElement) {
        formElement.focus();

        if (formElement.setSelectionRange) {
          formElement.value = decomposeSelectedComponents(formElement.value, formElement.selectionStart, formElement.selectionEnd);

        } else if (document.selection) {
          var nMoved;
          var range = document.selection.createRange();
          var rangeTmp = range.duplicate();
          var selectionStart = 0;
          var selectionEnd = 0;
          do {
            nMoved = rangeTmp.moveStart('character', -1);
            selectionStart -= nMoved;
          } while (nMoved != 0);
          selectionEnd = selectionStart + range.text.length;
          formElement.value = decomposeSelectedComponents(formElement.value, selectionStart, selectionEnd);

        } else {
          document.getElementById("msgStatus").innerHTML = "decomposition is not available on this system";
        }
      }

      function updateFontSize() {
        document.getElementById("foundIds").style.fontSize = parseInt(document.getElementById("outFontSize").value);
      }

      hideOptionForms();

      function showOptionForms() {
        var formForFontSize   = document.createElement("FORM");
        formForFontSize.id    = "formForFontSize";

        var inputForFontSize  = document.createElement("INPUT");
        inputForFontSize.type = "text";
        inputForFontSize.id   = "outFontSize";
        formForFontSize.appendChild(inputForFontSize);

        var buttonForFontSize = document.createElement("INPUT");
        buttonForFontSize.type = "button";
        buttonForFontSize.id   = "buttonToUpdateFontSize";
        buttonForFontSize.value = "change FontSize";
        buttonForFontSize.onclick = function() { updateFontSize(); };
        formForFontSize.appendChild(buttonForFontSize);

        document.getElementById("Setting").appendChild(formForFontSize);

        // ----

        var formForPngDir = document.createElement("FORM");
        formForPngDir.id = "formForPngDir";

        var inputForPngDir = document.createElement("INPUT");
        inputForPngDir.type = "text";
        inputForPngDir.id = "pngDir";
        if ( pngDir != null ) {
          inputForPngDir.value = pngDir;
        }
        inputForPngDir.addEventListener("change", function() {
          pngDir = document.getElementById("pngDir").value;
        }, false);
        formForPngDir.appendChild(inputForPngDir);

        var textForPngDir = document.createTextNode("dirname for PNG files");
        formForPngDir.appendChild(textForPngDir);

        var chkBoxForPng = document.createElement("INPUT");
        chkBoxForPng.type = "checkbox";
        chkBoxForPng.id = "showPng";
        if ( usePng ) {
          chkBoxForPng.checked = true;
        }
        chkBoxForPng.addEventListener("change", function() {
          usePng = document.getElementById("showPng").checked;
        }, false);
        formForPngDir.appendChild(chkBoxForPng);

        var textForPng = document.createTextNode("show PNG file");
        formForPngDir.appendChild(textForPng);

        document.getElementById("Setting").appendChild(formForPngDir);

        // ----

        var buttonForOptions = document.getElementById("buttonForOptions");
        if (buttonForOptions != undefined && buttonForOptions != null) {
          buttonForOptions.onclick = function() { hideOptionForms(); };
        }
        showOptions = true;
      }

      function hideOptionForms() {
        var nodeForSetting = document.getElementById("Setting");
        if (nodeForSetting == undefined || nodeForSetting == null)
          return;
        var chNodes = nodeForSetting.childNodes;
        if (chNodes == undefined || chNodes == null)
          return;
        var numChNodes = chNodes.length;
        for (var i = numChNodes; i > 0; ) {
          i -= 1;
          var chNodeId = chNodes[i].id;
          switch (chNodeId) {
          case "formForFontSize":
            nodeForSetting.removeChild(chNodes[i]);
            break;
          case "formForPngDir":
            nodeForSetting.removeChild(chNodes[i]);
            break;
          default:
          }
        }
        var buttonForOptions = document.getElementById("buttonForOptions");
        if (buttonForOptions != undefined && buttonForOptions != null) {
          buttonForOptions.onclick = function() { showOptionForms(); };
        }
        showOptions = false;
      }

      function updateOptionForms() {
        if (document.getElementById("chkboxForOptions").checked) {
          showOptionForms();
        } else {
          hideOptionForms();
        }
      }

      function updateDebug() {
        if (document.getElementById("chkboxForDebug").checked) {
          showDebug = true;
        } else {
          showDebug = false;
        }
      }

      function updateSort() {
        if (document.getElementById("chkboxForTotalStrokeSort").checked) {
          sortTotalStroke = true;
          if (foundChars != null) {
            sortFoundCharsByTotalStrokes();
          }
        } else {
          sortTotalStroke = false;
          if (foundChars != null) {
            sortFoundCharsByUCS();
          }
        }
        showFoundChars();
      }

    -->
    </script>
    <div id="wrapper">
      <div id="header">
      </div>
      <div id="sidebar">
        <div id="sidebarTop">
        </div>
        <div id="sidebarBody">
        </div>
      </div>
      <div id="maincontainer">
        <form id="Setting">
          <input type="checkbox" id="chkboxForDebug"   onclick="updateDebug()">debug
          <input type="checkbox" id="chkboxForOptions" onclick="updateOptionForms()">show options
          <input type="checkbox" id="chkboxForSideBar" onclick="updateSideBar()">show sidebar
        </form>
        <form name="IdsFile" onsubmit="return false;">
          <input type="file" name="pathToIds">
          <input type="button" id="buttonToLoadIds" value="load ids.txt" onclick="loadIdsFile()">
          <input type="button" id="buttonToParseIds" value="parse ids.txt" onclick="parseIdsText()">
        </form>
        <form name="UnihanFile" onsubmit="return false;">
          <input type="file" name="pathToUnihan">
          <input type="button" id="buttonToLoadUnihan" value="load Unihan.txt" onclick="loadUnihanFile()">
          <input type="button" id="buttonToParseUnihan" value="parse Unihan.txt" onclick="parseUnihanText()">
          <input type="checkbox" id="chkboxForTotalStrokeSort" onclick="updateSort()">sort by total stroke
        </form>
        <form name="checkComponent" onsubmit="return false;">
          <input type="text" name="components">
          <input type="button" value="lookup" onclick="lookupComponents()">
          <input type="button" value="decompose selected chars" onclick="wrapDecomposeSelectedComponents(this.form.elements[0])">
          <br>
          <input type="checkbox" id="chkboxForHexUcs" onclick="showFoundChars()">show UCS codepoint
          <br>
        </form>
        <div id="msgStatus">
        </div>
        <div id="foundIds">
          <div id="foundIdsHeader"></div>
          <div id="foundIdsBody"></div>
          <div id="foundIdsFooter"></div>
        </div>
      </div>
      <div id="footer">
      </div>
    </div>
    <script>
      document.getElementById("buttonToLoadIds").disabled = false;
      document.getElementById("buttonToParseIds").disabled = true;
      document.getElementById("buttonToLoadUnihan").disabled = false;
      document.getElementById("buttonToParseUnihan").disabled = true;
      document.getElementById("chkboxForTotalStrokeSort").disabled = true;
    </script>
  </body>
</html>
